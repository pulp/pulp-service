apiVersion: v1
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: grafana-dashboard-content-sources-business
  labels:
    grafana_dashboard: "true"
  annotations:
    grafana-folder: /grafana-dashboard-definitions/Insights
data:
  business_metrics.json: |-
    {
        "annotations": {
          "list": [
            {
              "builtIn": 1,
              "datasource": {
                "type": "grafana",
                "uid": "-- Grafana --"
              },
              "enable": true,
              "hide": true,
              "iconColor": "rgba(0, 211, 255, 1)",
              "name": "Annotations & Alerts",
              "target": {
                "limit": 100,
                "matchAny": false,
                "tags": [],
                "type": "dashboard"
              },
              "type": "dashboard"
            }
          ]
        },
        "editable": true,
        "fiscalYearStartMonth": 0,
        "graphTooltip": 2,
        "id": 1100022,
        "links": [],
        "panels": [
          {
            "collapsed": false,
            "gridPos": {
              "h": 1,
              "w": 24,
              "x": 0,
              "y": 0
            },
            "id": 2,
            "panels": [],
            "title": "Adoption",
            "type": "row"
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "stat",
            "title": "Daily Active Users (DAU)",
            "gridPos": {
              "h": 6,
              "w": 8,
              "x": 0,
              "y": 1
            },
            "id": 6,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| stats count_distinct(user) as daily_active_users by bin(24h)"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value",
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"]
              }
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "value": null,
                      "color": "green"
                    }
                  ]
                }
              }
            }
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "stat",
            "title": "Weekly Active Users (WAU)",
            "gridPos": {
              "h": 6,
              "w": 8,
              "x": 8,
              "y": 1
            },
            "id": 7,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| stats count_distinct(user) as weekly_active_users by bin(7d)"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value",
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"]
              }
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "value": null,
                      "color": "blue"
                    }
                  ]
                }
              }
            }
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "stat",
            "title": "Monthly Active Users (MAU)",
            "gridPos": {
              "h": 6,
              "w": 8,
              "x": 16,
              "y": 1
            },
            "id": 8,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| stats count_distinct(user) as monthly_active_users by bin(30d)"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value",
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"]
              }
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "value": null,
                      "color": "purple"
                    }
                  ]
                }
              }
            }
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "timeseries",
            "title": "Active Users Trend (DAU/WAU/MAU)",
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 7
            },
            "id": 9,
            "targets": [
              {
                "refId": "DAU",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| stats count_distinct(user) as value by bin(24h) as time"
              },
              {
                "refId": "WAU",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| stats count_distinct(user) as value by bin(7d) as time"
              },
              {
                "refId": "MAU",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| stats count_distinct(user) as value by bin(30d) as time"
              }
            ],
            "options": {
              "legend": {
                "displayMode": "table",
                "placement": "bottom",
                "showLegend": true,
                "calcs": ["lastNotNull", "max", "min"]
              }
            },
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "smooth",
                  "fillOpacity": 10
                }
              },
              "overrides": [
                {
                  "matcher": {
                    "id": "byName",
                    "options": "DAU"
                  },
                  "properties": [
                    {
                      "id": "color",
                      "value": {
                        "mode": "fixed",
                        "fixedColor": "green"
                      }
                    }
                  ]
                },
                {
                  "matcher": {
                    "id": "byName",
                    "options": "WAU"
                  },
                  "properties": [
                    {
                      "id": "color",
                      "value": {
                        "mode": "fixed",
                        "fixedColor": "blue"
                      }
                    }
                  ]
                },
                {
                  "matcher": {
                    "id": "byName",
                    "options": "MAU"
                  },
                  "properties": [
                    {
                      "id": "color",
                      "value": {
                        "mode": "fixed",
                        "fixedColor": "purple"
                      }
                    }
                  ]
                }
              ]
            }
          },
          {
            "collapsed": true,
            "gridPos": {
              "h": 1,
              "w": 24,
              "x": 0,
              "y": 15
            },
            "id": 3,
            "panels": [],
            "title": "Engagement and Retention",
            "type": "row"
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "barchart",
            "title": "New Users Per Day",
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            },
            "id": 10,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| filter @message like /New user created/\n| parse @message \"username=*, first_route=*\" as username, route\n| parse route '/api/pypi/*/pypi/' as distribution\n| filter distribution = '${distribution}'\n| stats count() as new_users by bin(24h) as time"
              }
            ],
            "options": {
              "orientation": "auto",
              "showValue": "auto",
              "legend": {
                "showLegend": false
              }
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                }
              }
            }
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "piechart",
            "title": "Active Users by Type",
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            },
            "id": 11,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| fields case(\n    user like /^\\/O=/, \"service_account\",\n    user like /^org:/, \"org_only\",\n    user like /@/, \"email\",\n    true, \"username\"\n  ) as user_type\n| stats count_distinct(user) as unique_users by user_type"
              }
            ],
            "options": {
              "pieType": "donut",
              "legend": {
                "displayMode": "table",
                "placement": "right",
                "showLegend": true,
                "values": ["value", "percent"]
              }
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                }
              }
            }
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "table",
            "title": "Top Active Users",
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 24
            },
            "id": 12,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| parse @message \"user:* org_id\" as user\n| parse @message '\"* /api/pypi/*/pypi/' as method, distribution\n| filter user != \"-\" and user != \"\"\n| filter distribution = '${distribution}'\n| stats count() as requests by user\n| sort requests desc\n| limit 20"
              }
            ],
            "options": {
              "showHeader": true
            },
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "align": "auto",
                  "filterable": true
                }
              }
            }
          },
          {
            "collapsed": true,
            "gridPos": {
              "h": 1,
              "w": 24,
              "x": 0,
              "y": 32
            },
            "id": 4,
            "panels": [],
            "title": "Package Usage",
            "type": "row"
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "fixedColor": "green",
                  "mode": "fixed"
                },
                "custom": {
                  "axisBorderShow": false,
                  "axisCenteredZero": false,
                  "axisColorMode": "text",
                  "axisLabel": "",
                  "axisPlacement": "auto",
                  "fillOpacity": 80,
                  "gradientMode": "none",
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "viz": false
                  },
                  "lineWidth": 1,
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green"
                    }
                  ]
                }
              },
              "overrides": []
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 33
            },
            "id": 1,
            "options": {
              "barRadius": 0,
              "barWidth": 0.97,
              "fullHighlight": false,
              "groupWidth": 0.7,
              "legend": {
                "calcs": [],
                "displayMode": "list",
                "placement": "bottom",
                "showLegend": true
              },
              "orientation": "auto",
              "showValue": "auto",
              "stacking": "none",
              "tooltip": {
                "hideZeros": false,
                "mode": "single",
                "sort": "none"
              },
              "xField": "package",
              "xTickLabelRotation": 0,
              "xTickLabelSpacing": 0
            },
            "pluginVersion": "11.6.3",
            "targets": [
              {
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "dimensions": {},
                "expression": "fields @timestamp, @message\n| filter @message like /\\/api\\/pypi\\/.*\\/pypi\\/simple\\//\n| parse @message '\"GET /api/pypi/*/pypi/simple/*/ HTTP' as distribution, package\n| filter strlen(package) > 0\n| filter distribution = '${distribution}'\n| stats count() as downloads by distribution, package\n| sort downloads desc\n| limit 10",
                "id": "",
                "label": "",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "matchExact": true,
                "metricEditorMode": 0,
                "metricName": "",
                "metricQueryType": 0,
                "namespace": "",
                "period": "",
                "queryLanguage": "CWLI",
                "queryMode": "Logs",
                "refId": "A",
                "region": "default",
                "sqlExpression": "",
                "statistic": "Average",
                "statsGroups": [
                  "distribution",
                  "package"
                ]
              }
            ],
            "title": "Top 10 Packages downloaded",
            "type": "barchart"
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "table",
            "title": "Tracked Package Usage (DISABLED)",
            "gridPos": {
              "h": 3,
              "w": 12,
              "x": 12,
              "y": 33
            },
            "id": 13,
            "description": "⚠️ DISABLED - Too many packages (397+) for filtering. Use table search in 'Top 10 Packages' instead.",
            "transparent": true,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| filter @message like /\\/api\\/pypi\\/.*\\/pypi\\/simple\\//\n| parse @message '\"GET /api/pypi/*/pypi/simple/*/ HTTP' as distribution, package\n| filter strlen(package) > 0\n| filter distribution = '${distribution}'\n| filter package in [${package_filter:singlequote}]\n| stats count() as downloads by package\n| sort downloads desc"
              }
            ],
            "options": {
              "showHeader": true,
              "footer": {
                "show": true,
                "reducer": ["sum"],
                "fields": ["downloads"]
              }
            },
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "align": "auto",
                  "filterable": true
                }
              },
              "overrides": [
                {
                  "matcher": {
                    "id": "byName",
                    "options": "downloads"
                  },
                  "properties": [
                    {
                      "id": "custom.width",
                      "value": 120
                    },
                    {
                      "id": "color",
                      "value": {
                        "mode": "thresholds"
                      }
                    },
                    {
                      "id": "thresholds",
                      "value": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "value": null,
                            "color": "red"
                          },
                          {
                            "value": 1,
                            "color": "yellow"
                          },
                          {
                            "value": 100,
                            "color": "green"
                          }
                        ]
                      }
                    }
                  ]
                }
              ]
            }
          },
          {
            "datasource": {
              "type": "cloudwatch",
              "uid": "P1A97A9592CB7F392"
            },
            "type": "table",
            "title": "80/20 Download Concentration (DISABLED)",
            "gridPos": {
              "h": 3,
              "w": 24,
              "x": 0,
              "y": 41
            },
            "id": 14,
            "description": "⚠️ DISABLED - Too many packages (397+). Manually analyze download data or use CloudWatch Insights for 80/20 analysis.",
            "transparent": true,
            "targets": [
              {
                "refId": "A",
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "P1A97A9592CB7F392"
                },
                "queryMode": "Logs",
                "region": "default",
                "logGroups": [
                  {
                    "accountId": "744086762512",
                    "arn": "arn:aws:logs:us-east-1:744086762512:log-group:${log_group}:*",
                    "name": "${log_group}"
                  }
                ],
                "expression": "fields @timestamp, @message\n| filter @message like /\\/api\\/pypi\\/.*\\/pypi\\/simple\\//\n| parse @message '\"GET /api/pypi/*/pypi/simple/*/ HTTP' as distribution, package\n| filter strlen(package) > 0\n| filter distribution = '${distribution}'\n| stats count() as downloads by package\n| sort downloads desc\n| limit 50"
              }
            ],
            "options": {
              "showHeader": true,
              "footer": {
                "show": true,
                "reducer": ["sum"],
                "fields": ["downloads"]
              }
            },
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "align": "auto",
                  "filterable": true
                }
              },
              "overrides": [
                {
                  "matcher": {
                    "id": "byName",
                    "options": "downloads"
                  },
                  "properties": [
                    {
                      "id": "custom.width",
                      "value": 150
                    },
                    {
                      "id": "unit",
                      "value": "short"
                    }
                  ]
                }
              ]
            },
            "transformations": [
              {
                "id": "calculateField",
                "options": {
                  "mode": "reduceRow",
                  "reduce": {
                    "reducer": "sum"
                  },
                  "replaceFields": false,
                  "alias": "total"
                }
              },
              {
                "id": "calculateField",
                "options": {
                  "mode": "binary",
                  "binary": {
                    "left": "downloads",
                    "operator": "/",
                    "right": "total"
                  },
                  "reduce": {
                    "reducer": "sum"
                  },
                  "replaceFields": false,
                  "alias": "percentage"
                }
              },
              {
                "id": "organize",
                "options": {
                  "excludeByName": {
                    "total": true
                  },
                  "indexByName": {
                    "package": 0,
                    "downloads": 1,
                    "percentage": 2
                  },
                  "renameByName": {
                    "percentage": "% of Total"
                  }
                }
              }
            ]
          },
          {
            "collapsed": true,
            "gridPos": {
              "h": 1,
              "w": 24,
              "x": 0,
              "y": 49
            },
            "id": 5,
            "panels": [],
            "title": "User Demographics",
            "type": "row"
          }
        ],
        "preload": false,
        "refresh": "",
        "schemaVersion": 41,
        "tags": [],
        "templating": {
          "list": [
            {
              "type": "custom",
              "name": "log_group",
              "label": "Environment",
              "query": "crcs02ue1.pulp-stage,crcp01ue1.pulp-prod",
              "current": {
                "selected": true,
                "text": "crcp01ue1.pulp-prod",
                "value": "crcp01ue1.pulp-prod"
              },
              "options": [
                {
                  "text": "Stage",
                  "value": "crcs02ue1.pulp-stage",
                  "selected": false
                },
                {
                  "text": "Production",
                  "value": "crcp01ue1.pulp-prod",
                  "selected": true
                }
              ],
              "includeAll": false,
              "multi": false,
              "skipUrlSync": false,
              "hide": 0
            },
            {
              "type": "custom",
              "name": "distribution",
              "label": "Distribution",
              "query": "public-calunga,public-calunga-prod",
              "current": {
                "selected": true,
                "text": "public-calunga-prod",
                "value": "public-calunga-prod"
              },
              "options": [
                {
                  "text": "Calunga",
                  "value": "public-calunga",
                  "selected": false
                },
                {
                  "text": "Calunga Prod",
                  "value": "public-calunga-prod",
                  "selected": true
                }
              ],
              "includeAll": false,
              "multi": false,
              "skipUrlSync": false,
              "hide": 0
            },
            {
              "type": "custom",
              "name": "package_filter",
              "label": "Package Filter",
              "query": "Django,SecretStorage,aiodns,aiohttp,annotated-types,asgiref,cffi,crc-pulp_python-client,crc-pulpcore-client,cryptography,jaraco.classes,jaraco.context,jaraco.functools,jeepney,jq,keyring,more-itertools,pycparser,pydantic,pydantic_core,python-dateutil,six,sqlparse,typing-inspection,typing_extensions,urllib3",
              "current": {
                "selected": true,
                "text": "All",
                "value": "$__all"
              },
              "options": [],
              "includeAll": true,
              "multi": true,
              "allValue": null,
              "skipUrlSync": false,
              "hide": 0
            }
          ]
        },
        "time": {
          "from": "now-30d",
          "to": "now"
        },
        "timepicker": {
          "refresh_intervals": [
            "30s",
            "1m",
            "5m",
            "15m",
            "30m",
            "1h",
            "2h",
            "1d"
          ]
        },
        "timezone": "",
        "title": "Pulp Business Metrics",
        "uid": "pulp-business-dashboard",
        "version": 1
      }
