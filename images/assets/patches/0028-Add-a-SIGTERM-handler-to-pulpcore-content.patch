From 049c3fc2cfb981a34afbeddbb47df9da4a1302b7 Mon Sep 17 00:00:00 2001
From: git-hyagi <45576767+git-hyagi@users.noreply.github.com>
Date: Thu, 16 Oct 2025 14:41:13 -0300
Subject: [PATCH] Add a SIGTERM handler to pulpcore-content

---
 pulpcore/content/__init__.py   | 9 +++++++++
 pulpcore/content/entrypoint.py | 1 +
 2 files changed, 10 insertions(+)

diff --git a/pulpcore/content/__init__.py b/pulpcore/content/__init__.py
index 29c55ba13..d11d0985b 100644
--- a/pulpcore/content/__init__.py
+++ b/pulpcore/content/__init__.py
@@ -4,6 +4,10 @@ from importlib import import_module
 from importlib.util import find_spec
 import logging
 import os
+import signal
+import sys
+import threading
+import traceback
 
 from asgiref.sync import sync_to_async
 from aiohttp import web
@@ -94,8 +98,13 @@ async def _heartbeat_ctx(app):
     except asyncio.CancelledError:
         pass
 
+def _signal_handler(sig, frame):
+    log.info(f"SIGTERM received!")
+    for th in threading.enumerate():
+        traceback.print_stack(sys._current_frames()[th.ident])
 
 async def server(*args, **kwargs):
+    signal.signal(signal.SIGTERM, _signal_handler)
     os.chdir(settings.WORKING_DIRECTORY)
 
     for pulp_plugin in pulp_plugin_configs():
diff --git a/pulpcore/content/entrypoint.py b/pulpcore/content/entrypoint.py
index 0a878c16e..9cc3ab5a3 100644
--- a/pulpcore/content/entrypoint.py
+++ b/pulpcore/content/entrypoint.py
@@ -48,6 +48,7 @@ class PulpcoreContentApplication(PulpcoreGunicornApplication):
 @click.option("--chdir")
 @click.option("--user", "-u")
 @click.option("--group", "-g")
+@click.option("--config", "-c")
 @click.command()
 def main(bind, **options):
     options["bind"] = list(bind)
-- 
2.46.2

