From c8806fd712f0e9b2a248c6410e93a1f783194b5e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andr=C3=A9=20=22decko=22=20de=20Brito?= <decko@redhat.com>
Date: Thu, 21 Nov 2024 08:08:19 -0300
Subject: [PATCH] Change how the exceptions are propagated on the Content
 instrumentation middleware.

Closes #6925

Co-authored-by: git-hyagi <45576767+git-hyagi@users.noreply.github.com>
---
 CHANGES/6925.bugfix                 |  1 +
 pulpcore/content/instrumentation.py | 33 ++++++++++++++++-------------
 2 files changed, 19 insertions(+), 15 deletions(-)
 create mode 100644 CHANGES/6925.bugfix

diff --git a/CHANGES/6925.bugfix b/CHANGES/6925.bugfix
new file mode 100644
index 000000000..8376f0a77
--- /dev/null
+++ b/CHANGES/6925.bugfix
@@ -0,0 +1 @@
+Fixed exception propagation in the pulp-content instrumentation middleware.
diff --git a/pulpcore/content/instrumentation.py b/pulpcore/content/instrumentation.py
index 2755fe578..5b9d95e84 100644
--- a/pulpcore/content/instrumentation.py
+++ b/pulpcore/content/instrumentation.py
@@ -21,23 +21,26 @@ def instrumentation(exporter=None, reader=None, provider=None):
         try:
             response = await handler(request)
             status_code = response.status
+
+            return response
         except web.HTTPException as exc:
             status_code = exc.status
-            response = exc
-
-        duration_ms = (time.time() - start_time) * 1000
-
-        request_duration_histogram.record(
-            duration_ms,
-            attributes={
-                "http.method": request.method,
-                "http.status_code": normalize_http_status(status_code),
-                "http.route": _get_view_request_handler_func(request),
-                "worker.name": get_worker_name(),
-            },
-        )
-
-        return response
+            raise exc
+        except Exception as exc:
+            status_code = exc.status if hasattr(exc, "status") else 500
+            raise exc
+        finally:
+            duration_ms = (time.time() - start_time) * 1000
+
+            request_duration_histogram.record(
+                duration_ms,
+                attributes={
+                    "http.method": request.method,
+                    "http.status_code": normalize_http_status(status_code),
+                    "http.route": _get_view_request_handler_func(request),
+                    "worker.name": get_worker_name(),
+                },
+            )
 
     return middleware
 
-- 
2.51.0

