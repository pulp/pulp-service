From 9a67a959aab1bb26cf37a9b5220567ad9c7d75d2 Mon Sep 17 00:00:00 2001
From: Dennis Kliban <dkliban@redhat.com>
Date: Tue, 4 Mar 2025 11:19:30 -0500
Subject: [PATCH] Re-root the registry API at /api/pulp/v2/

---
 pulp_container/app/redirects.py    |  2 +-
 pulp_container/app/registry_api.py |  4 +++-
 pulp_container/app/urls.py         | 12 ++++++------
 3 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/pulp_container/app/redirects.py b/pulp_container/app/redirects.py
index b431faee..a37d6567 100644
--- a/pulp_container/app/redirects.py
+++ b/pulp_container/app/redirects.py
@@ -34,7 +34,7 @@ class CommonRedirects:
 
         return self.distribution.redirect_to_content_app(
             urljoin(
-                settings.CONTENT_ORIGIN,
+                "https://mtls.internal.console.redhat.com",
                 f"/{self.path_prefix}/{self.path}/{content_type}/{content_id}",
             )
         )
diff --git a/pulp_container/app/registry_api.py b/pulp_container/app/registry_api.py
index 2a085786..ccf84495 100644
--- a/pulp_container/app/registry_api.py
+++ b/pulp_container/app/registry_api.py
@@ -97,6 +97,8 @@ from pulp_container.constants import (
     V2_ACCEPT_HEADERS,
 )
 
+from pulp_service.app.authentication import RHServiceAccountCertAuthentication
+
 log = logging.getLogger(__name__)
 
 IGNORED_PULL_THROUGH_REMOTE_ATTRIBUTES = [
@@ -233,7 +235,7 @@ class ContainerRegistryApiMixin:
         List of authentication classes to check for this view.
         """
         if settings.get("TOKEN_AUTH_DISABLED", False):
-            return [RegistryAuthentication]
+            return [RHServiceAccountCertAuthentication]
         return [TokenAuthentication]
 
     @property
diff --git a/pulp_container/app/urls.py b/pulp_container/app/urls.py
index 864f0b2e..b6054931 100644
--- a/pulp_container/app/urls.py
+++ b/pulp_container/app/urls.py
@@ -26,16 +26,16 @@ head_route = Route(
 )
 
 router.routes.append(head_route)
-router.register(r"^v2/(?P<path>.+)/blobs/uploads\/?", BlobUploads, basename="docker-upload")
-router.register(r"^v2/(?P<path>.+)/blobs", Blobs, basename="blobs")
-router.register(r"^v2/(?P<path>.+)/manifests", Manifests, basename="manifests")
+router.register(r"^api/pulp/v2/(?P<path>.+)/blobs/uploads\/?", BlobUploads, basename="docker-upload")
+router.register(r"^api/pulp/v2/(?P<path>.+)/blobs", Blobs, basename="blobs")
+router.register(r"^api/pulp/v2/(?P<path>.+)/manifests", Manifests, basename="manifests")
 router.register(r"^extensions/v2/(?P<path>.+)/signatures", Signatures, basename="signatures")
 
 urlpatterns = [
     path("token/", BearerTokenView.as_view()),
-    path("v2/", VersionView.as_view()),
-    path("v2/_catalog", CatalogView.as_view()),
-    path("v2/<path:path>/tags/list", TagsListView.as_view()),
+    path("api/pulp/v2/", VersionView.as_view()),
+    path("api/pulp/v2/_catalog", CatalogView.as_view()),
+    path("api/pulp/v2/<path:path>/tags/list", TagsListView.as_view()),
     path("", include(router.urls)),
 ]
 if settings.FLATPAK_INDEX:
-- 
2.48.1

