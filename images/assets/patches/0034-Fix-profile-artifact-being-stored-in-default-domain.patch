From 29b7dc1a6537e6cc1bc93e0268421c856401ff52 Mon Sep 17 00:00:00 2001
From: git-hyagi <45576767+git-hyagi@users.noreply.github.com>
Date: Fri, 12 Dec 2025 16:43:10 -0300
Subject: [PATCH] Fix profile artifact being stored in default domain

ref: https://issues.redhat.com/browse/PULP-1044
---
 pulpcore/tasking/_util.py | 31 ++++++++++++++++++-------------
 1 file changed, 18 insertions(+), 13 deletions(-)

diff --git a/pulpcore/tasking/_util.py b/pulpcore/tasking/_util.py
index 7274d7cb8..37968200a 100644
--- a/pulpcore/tasking/_util.py
+++ b/pulpcore/tasking/_util.py
@@ -16,6 +16,7 @@ from django.db.models import Q
 from django.utils import timezone
 from django_guid import set_guid
 from django_guid.utils import generate_guid
+from pulpcore.app.contexts import with_domain
 from pulpcore.app.models import Artifact, Content, Task, TaskSchedule, ProfileArtifact
 from pulpcore.app.util import (
     configure_analytics,
@@ -167,18 +168,21 @@ def _pyinstrument_diagnostic_decorator(temp_dir, func):
                 f.write(profiler.output_html())
                 f.flush()
 
-            artifact = Artifact.init_and_validate(str(profile_file_path))
-            try:
-                # it is possible for the diagnostic artifact (memory report) to be identical to
-                # a previous report, in which case we need to handle the case where saving a new
-                # artifact fails.
-                artifact.save()
-            except IntegrityError:
-                artifact = Artifact.objects.get(sha256=artifact.sha256)
-
-            ProfileArtifact.objects.get_or_create(
-                artifact=artifact, name="pyinstrument_profile", task=task
-            )
+            with with_domain(task.pulp_domain):
+                artifact = Artifact.init_and_validate(str(profile_file_path))
+                try:
+                    # it is possible for the diagnostic artifact (memory report) to be identical
+                    # to a previous report, in which case we need to handle the case where saving
+                    # a new artifact fails.
+                    artifact.save()
+                except IntegrityError:
+                    artifact = Artifact.objects.get(
+                        sha256=artifact.sha256, pulp_domain=task.pulp_domain
+                    )
+
+                ProfileArtifact.objects.get_or_create(
+                    artifact=artifact, name="pyinstrument_profile", task=task
+                )
             _logger.info("Created pyinstrument profile data.")
         else:
             func(task)
@@ -200,13 +204,14 @@ def _memray_diagnostic_decorator(temp_dir, func):
                 func(task)
 
             artifact = Artifact.init_and_validate(str(profile_file_path))
+            artifact.pulp_domain = task.pulp_domain
             try:
                 # it is possible for the diagnostic artifact (memory report) to be identical to
                 # a previous report, in which case we need to handle the case where saving a new
                 # artifact fails.
                 artifact.save()
             except IntegrityError:
-                artifact = Artifact.objects.get(sha256=artifact.sha256)
+                artifact = Artifact.objects.get(sha256=artifact.sha256, pulp_domain=task.pulp_domain)
 
             ProfileArtifact.objects.get_or_create(
                 artifact=artifact, name="memray_profile", task=task
-- 
2.46.2

